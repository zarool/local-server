name: Dynamic GitOps Deploy

on:
  push:
    paths:
      - 'middleware/**'

jobs:
  # STEP 1: Detect which charts changed
  detect-changes:
    runs-on: arc-runner-set
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        run: |
          # Find directories in middleware/ that have changed
          # 'sed' extracts the chart name (e.g., middleware/grafana/foo -> grafana)
          DIFF=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^middleware/' | cut -d/ -f2 | sort -u || true)

          if [ -z "$DIFF" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # Convert list to JSON array: ["chart1", "chart2"]
            JSON_ARRAY=$(echo "$DIFF" | jq -R . | jq -s -c .)
            echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  # STEP 2: Run parallel pipelines for each detected chart
  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: arc-runner-set
    strategy:
      matrix:
        chart: ${{è¡” fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false # Don't kill other deploys if one fails

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        # Use the script we built earlier to install helm, helmfile, and plugins
        run: |
          # (Your installation script here)
          echo "Setting up environment for ${{ matrix.chart }}"

      - name: Deploy Chart
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          # Look for the specific helmfile inside the chart directory
          CHART_DIR="middleware/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/helmfile.yaml" ]; then
            helmfile -f $CHART_DIR/helmfile.yaml apply
          else
            echo "No helmfile found in $CHART_DIR, skipping..."
          fi
